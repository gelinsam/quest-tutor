<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Quest Tutor">
<meta name="theme-color" content="#1a0533">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Quest Tutor</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;height:100dvh;overflow:hidden}
body{
  font-family:'Fredoka',sans-serif;
  background:#1a0533;color:white;
  touch-action:manipulation;-webkit-user-select:none;user-select:none;
  display:flex;flex-direction:column;
}

/* === ANIMATED BACKGROUND CANVAS === */
#scene{position:fixed;inset:0;z-index:0}

/* === FLOATING PARTICLES (CSS) === */
.particle{position:fixed;pointer-events:none;z-index:1;border-radius:50%;animation:floatUp var(--dur) linear forwards;opacity:0}
@keyframes floatUp{0%{opacity:0;transform:translateY(0) scale(0.3)}10%{opacity:1}80%{opacity:0.8}100%{opacity:0;transform:translateY(var(--travel)) scale(0.1) rotate(360deg)}}

/* === SETUP === */
#setup{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:14px;overflow-y:auto;background:linear-gradient(135deg,#1a0533,#0d1b3e,#0a2a1f)}
#setup.gone{display:none}

.s-char-big{font-size:100px;animation:charBounce 2s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(255,200,0,0.5))}
@keyframes charBounce{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-20px) rotate(3deg)}}

.s-title{font-size:clamp(32px,9vw,52px);font-weight:700;text-align:center;line-height:1;
  background:linear-gradient(135deg,#FFD700,#FF6B6B,#00D4FF,#7C4DFF);background-size:300% 300%;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:gradShift 4s ease infinite}
@keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.s-sub{font-size:16px;opacity:0.6;text-align:center}

.s-group{width:100%;max-width:340px}
.s-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin:12px 0 6px;opacity:0.5}
.s-input{
  width:100%;padding:16px 20px;font-size:18px;font-family:inherit;
  background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);border-radius:20px;
  color:white;outline:none;transition:border .2s
}
.s-input:focus{border-color:#00D4FF}
.s-input::placeholder{color:rgba(255,255,255,0.3)}

.s-pills{display:flex;gap:8px}
.s-pill{
  flex:1;padding:14px;text-align:center;border-radius:16px;
  font-size:14px;font-weight:600;cursor:pointer;
  border:2px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);
  transition:all .2s;opacity:0.6
}
.s-pill.on{border-color:#00D4FF;background:rgba(0,212,255,0.12);opacity:1;transform:scale(1.05)}

.s-go{
  font-family:inherit;font-size:22px;font-weight:700;padding:18px 56px;margin-top:16px;
  background:linear-gradient(135deg,#22c55e,#16a34a);color:white;
  border:none;border-radius:60px;cursor:pointer;
  box-shadow:0 8px 40px rgba(34,197,94,.4);transition:transform .15s;
  letter-spacing:1px;text-transform:uppercase;position:relative;overflow:hidden
}
.s-go::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transform:translateX(-100%);animation:shimmer 2s ease infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.s-go:active{transform:scale(0.93)}
.s-note{font-size:10px;opacity:0.35;text-align:center;max-width:280px}

/* === MAIN GAME === */
#game{display:none;position:fixed;inset:0;z-index:2;flex-direction:column}
#game.on{display:flex}

/* === TOP HUD â€” minimal, game-style === */
.hud{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;z-index:10;flex-shrink:0;
  background:linear-gradient(180deg,rgba(0,0,0,0.6),transparent);
  padding-top:max(10px,env(safe-area-inset-top))
}
.hud-left{display:flex;align-items:center;gap:10px}
.hud-ring{width:48px;height:48px;position:relative}
.hud-ring svg{width:48px;height:48px;transform:rotate(-90deg)}
.hud-ring .ring-bg{fill:none;stroke:rgba(255,255,255,0.1);stroke-width:4}
.hud-ring .ring-fill{fill:none;stroke:#FFD700;stroke-width:4;stroke-linecap:round;transition:stroke-dashoffset 0.6s ease}
.hud-lv{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#FFD700}
.hud-right{display:flex;gap:14px;align-items:center}
.hud-stat{font-size:15px;font-weight:700;display:flex;align-items:center;gap:3px}
.hud-streak{color:#FF6B6B}
.hud-coins{color:#FFD700}
.hud-gear{background:none;border:none;font-size:24px;cursor:pointer;padding:4px;opacity:0.6}

/* === CHARACTER AREA === */
.char-zone{
  flex:0 0 auto;display:flex;flex-direction:column;align-items:center;
  padding:0 20px;position:relative;z-index:5
}

/* SVG Character */
.char-svg{width:160px;height:160px;animation:charFloat 3s ease-in-out infinite;filter:drop-shadow(0 10px 30px rgba(0,0,0,0.4));position:relative}
@keyframes charFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.char-svg.happy{animation:charCelebrate 0.6s ease}
@keyframes charCelebrate{0%{transform:scale(1) rotate(0)}20%{transform:scale(1.3) rotate(-15deg)}40%{transform:scale(1.2) rotate(15deg)}60%{transform:scale(1.25) rotate(-8deg)}100%{transform:scale(1) rotate(0)}}
.char-svg.sad{animation:charSad 0.5s ease}
@keyframes charSad{0%{transform:scale(1)}40%{transform:scale(0.8) translateY(10px)}100%{transform:scale(1)}}

/* Speech â€” just a short voice indicator, NOT a text bubble */
.voice-indicator{
  margin-top:4px;padding:8px 20px;border-radius:30px;
  background:rgba(255,255,255,0.1);backdrop-filter:blur(8px);
  font-size:14px;font-weight:600;opacity:0.7;
  display:flex;align-items:center;gap:8px;
  max-width:250px;text-align:center;transition:all 0.3s
}
.voice-indicator.speaking{opacity:1;background:rgba(0,212,255,0.15)}
.voice-wave{display:flex;gap:2px;align-items:center;height:16px}
.voice-wave span{width:3px;background:#00D4FF;border-radius:2px;animation:wave 0.8s ease-in-out infinite}
.voice-wave span:nth-child(1){height:6px;animation-delay:0s}
.voice-wave span:nth-child(2){height:12px;animation-delay:0.1s}
.voice-wave span:nth-child(3){height:8px;animation-delay:0.2s}
.voice-wave span:nth-child(4){height:14px;animation-delay:0.3s}
.voice-wave span:nth-child(5){height:6px;animation-delay:0.4s}
@keyframes wave{0%,100%{height:4px}50%{height:16px}}
.voice-indicator:not(.speaking) .voice-wave span{animation:none;height:4px}

/* === ANSWER CARDS â€” BIG visual cards === */
.cards{
  flex:1;display:grid;grid-template-columns:1fr 1fr;
  gap:12px;padding:12px 16px;align-content:center;
  z-index:5;padding-bottom:max(16px,env(safe-area-inset-bottom))
}
.card{
  border-radius:24px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:16px 10px;gap:6px;
  border:3px solid rgba(255,255,255,0.12);
  position:relative;overflow:hidden;
  transition:all 0.2s;min-height:120px;
  background:rgba(255,255,255,0.06);backdrop-filter:blur(10px)
}
.card::before{
  content:'';position:absolute;inset:0;border-radius:21px;
  background:var(--card-bg);opacity:0.15;transition:opacity 0.2s
}
.card:active{transform:scale(0.93)}
.card-icon{font-size:52px;position:relative;z-index:1;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));transition:transform 0.3s}
.card-label{font-size:15px;font-weight:700;position:relative;z-index:1;text-align:center;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,0.5)}
.card:nth-child(1){--card-bg:linear-gradient(135deg,#3B82F6,#06B6D4)}
.card:nth-child(2){--card-bg:linear-gradient(135deg,#8B5CF6,#EC4899)}
.card:nth-child(3){--card-bg:linear-gradient(135deg,#F59E0B,#EF4444)}
.card:nth-child(4){--card-bg:linear-gradient(135deg,#10B981,#059669)}

.card.correct{border-color:#22c55e;animation:cardCorrect 0.5s ease}
.card.correct::before{opacity:0.3;background:linear-gradient(135deg,#22c55e,#4ade80)!important}
.card.correct .card-icon{transform:scale(1.3)}
@keyframes cardCorrect{0%{transform:scale(1)}30%{transform:scale(1.1)}100%{transform:scale(1)}}

.card.wrong{border-color:#ef4444;animation:cardWrong 0.4s ease;opacity:0.5}
@keyframes cardWrong{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

.card.dimmed{opacity:0.3;transform:scale(0.95);pointer-events:none}

/* Loading state */
.cards-loading{display:flex;align-items:center;justify-content:center;flex:1;z-index:5}
.loader{width:80px;height:80px;position:relative}
.loader-ring{position:absolute;inset:0;border:4px solid transparent;border-top-color:#FFD700;border-radius:50%;animation:spin 1s linear infinite}
.loader-ring:nth-child(2){inset:10px;border-top-color:#00D4FF;animation-duration:0.8s;animation-direction:reverse}
.loader-ring:nth-child(3){inset:20px;border-top-color:#FF6B6B;animation-duration:0.6s}
@keyframes spin{to{transform:rotate(360deg)}}

/* === SUBJECT SELECTOR â€” floating bubbles at bottom === */
.subj-bar{
  display:flex;gap:6px;padding:8px 12px;z-index:10;flex-shrink:0;
  justify-content:center;
  background:linear-gradient(0deg,rgba(0,0,0,0.6),transparent);
  padding-bottom:max(8px,env(safe-area-inset-bottom))
}
.subj-btn{
  width:54px;height:54px;border-radius:50%;border:3px solid rgba(255,255,255,0.1);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;cursor:pointer;transition:all 0.25s;
  background:rgba(255,255,255,0.06);position:relative
}
.subj-btn.on{border-color:#FFD700;background:rgba(255,215,0,0.15);transform:scale(1.15);box-shadow:0 0 20px rgba(255,215,0,0.3)}
.subj-btn::after{
  content:attr(data-label);position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);
  font-size:9px;font-weight:700;white-space:nowrap;opacity:0;transition:opacity 0.2s
}
.subj-btn.on::after{opacity:0.6}

/* === FREE TALK INPUT === */
.talk-bar{
  display:none;padding:8px 12px;gap:8px;align-items:center;z-index:10;
  background:rgba(0,0,0,0.5);flex-shrink:0;
  padding-bottom:max(8px,env(safe-area-inset-bottom))
}
.talk-bar.on{display:flex}
.talk-field{
  flex:1;padding:14px 20px;font-size:17px;font-family:inherit;
  background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.1);border-radius:50px;
  color:white;outline:none;resize:none;min-height:44px;max-height:80px
}
.talk-field:focus{border-color:#00D4FF}
.talk-field::placeholder{color:rgba(255,255,255,0.3)}
.circle-btn{
  width:50px;height:50px;border-radius:50%;border:none;
  display:flex;align-items:center;justify-content:center;
  font-size:24px;cursor:pointer;flex-shrink:0;transition:transform .15s
}
.circle-btn:active{transform:scale(0.88)}
.mic-btn{background:linear-gradient(135deg,#F59E0B,#EF4444)}
.mic-btn.listening{background:linear-gradient(135deg,#22c55e,#059669);animation:pulse 1.2s ease infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{box-shadow:0 0 0 18px rgba(34,197,94,0)}}
.send-btn{background:linear-gradient(135deg,#3B82F6,#06B6D4)}

/* === STREAK FIRE â€” big animated fire on streak === */
.streak-fire{
  position:fixed;bottom:0;left:0;right:0;height:120px;z-index:3;
  pointer-events:none;opacity:0;transition:opacity 0.5s;
  background:linear-gradient(0deg,rgba(255,100,0,0.3),transparent)
}
.streak-fire.on{opacity:1}

/* === REWARD BURST === */
.reward-burst{
  position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;
  flex-direction:column;gap:10px;background:rgba(0,0,0,0.85);padding:24px
}
.reward-burst.show{display:flex}
.rb-icon{font-size:100px;animation:rbPop 0.6s cubic-bezier(0.175,0.885,0.32,1.275)}
@keyframes rbPop{0%{transform:scale(0) rotate(-30deg);opacity:0}50%{transform:scale(1.3) rotate(10deg)}100%{transform:scale(1) rotate(0);opacity:1}}
.rb-title{font-size:clamp(28px,8vw,42px);font-weight:700;text-align:center;
  background:linear-gradient(135deg,#FFD700,#FF6B6B);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.rb-sub{font-size:18px;opacity:0.6;text-align:center}
.rb-dismiss{font-size:12px;opacity:0.3;margin-top:20px}

/* === CONFETTI === */
.confetti{position:fixed;width:10px;height:10px;z-index:300;pointer-events:none;border-radius:2px;animation:confDrop var(--dur) ease forwards}
@keyframes confDrop{0%{opacity:1;transform:translateY(0) rotate(0) scale(1)}100%{opacity:0;transform:translateY(var(--dy)) translateX(var(--dx)) rotate(var(--rot)) scale(0.2)}}

/* === XP FLOAT === */
.xp-fly{position:fixed;font-size:26px;font-weight:700;color:#FFD700;pointer-events:none;z-index:250;text-shadow:0 0 20px rgba(255,215,0,0.6);animation:fly 1.4s ease forwards}
@keyframes fly{0%{opacity:1;transform:translateY(0) scale(0.5)}20%{opacity:1;transform:translateY(-20px) scale(1.3)}100%{opacity:0;transform:translateY(-100px) scale(0.6)}}

/* === STAR BURST (correct answer) === */
.star-burst{position:fixed;pointer-events:none;z-index:250;animation:starBurst 0.8s ease forwards}
@keyframes starBurst{0%{opacity:1;transform:translate(var(--tx),var(--ty)) scale(0)}30%{opacity:1;transform:translate(var(--tx),var(--ty)) scale(1.5)}100%{opacity:0;transform:translate(calc(var(--tx) + var(--dx)),calc(var(--ty) + var(--dy))) scale(0)}}

/* === SETTINGS PANEL === */
.settings{position:fixed;inset:0;z-index:400;background:rgba(26,5,51,0.97);display:none;flex-direction:column;overflow-y:auto;padding:20px}
.settings.show{display:flex}
.settings-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.settings-title{font-size:20px;font-weight:700}
.settings-x{font-size:28px;background:none;border:none;color:white;cursor:pointer;padding:8px}
.settings-section{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;opacity:0.4;margin:16px 0 8px}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.06)}
.settings-row label{font-size:15px;opacity:0.8;font-weight:500}
.tog{width:50px;height:28px;border-radius:14px;cursor:pointer;position:relative;background:rgba(255,255,255,0.15);border:none;transition:background .2s}
.tog.on{background:#22c55e}
.tog::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:white;top:3px;left:3px;transition:transform .2s}
.tog.on::after{transform:translateX(22px)}
.stat-val{font-size:15px;font-weight:700;color:#FFD700}
.reset-btn{background:#ef4444;border:none;color:white;padding:10px 20px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;margin-top:16px;font-family:inherit}

/* === SCREEN EFFECTS === */
.screen-flash{position:fixed;inset:0;z-index:150;pointer-events:none;opacity:0;transition:opacity 0.1s}
.screen-flash.green{background:rgba(34,197,94,0.2);opacity:1}
.screen-flash.red{background:rgba(239,68,68,0.15);opacity:1}
.screen-shake{animation:shake 0.3s ease}
@keyframes shake{0%,100%{transform:translate(0)}20%{transform:translate(-5px,2px)}40%{transform:translate(5px,-2px)}60%{transform:translate(-3px,1px)}80%{transform:translate(3px,-1px)}}
</style>
</head>
<body>

<canvas id="scene"></canvas>
<div class="screen-flash" id="flash"></div>

<!-- ====== SETUP ====== -->
<div id="setup">
  <div class="s-char-big">ğŸš€</div>
  <div class="s-title">QUEST TUTOR</div>
  <div class="s-sub">Your learning adventure awaits!</div>

  <div class="s-group">
    <div class="s-label">AI Provider</div>
    <div class="s-pills">
      <div class="s-pill on" data-p="anthropic" onclick="sPill(this)">Claude</div>
      <div class="s-pill" data-p="openai" onclick="sPill(this)">OpenAI</div>
      <div class="s-pill" data-p="groq" onclick="sPill(this)">Groq</div>
    </div>

    <div class="s-label">API Key</div>
    <input class="s-input" id="f-key" type="password" placeholder="sk-...">

    <div class="s-label">Child's Name</div>
    <input class="s-input" id="f-name" placeholder="e.g. Max">
  </div>

  <button class="s-go" onclick="startApp()">START ADVENTURE</button>
  <div class="s-note">Key stays on this device only.</div>
</div>

<!-- ====== GAME ====== -->
<div id="game">
  <!-- HUD -->
  <div class="hud">
    <div class="hud-left">
      <div class="hud-ring">
        <svg viewBox="0 0 48 48">
          <circle class="ring-bg" cx="24" cy="24" r="20"/>
          <circle class="ring-fill" id="xp-ring" cx="24" cy="24" r="20" stroke-dasharray="125.66" stroke-dashoffset="125.66"/>
        </svg>
        <div class="hud-lv" id="hud-lv">1</div>
      </div>
    </div>
    <div class="hud-right">
      <div class="hud-stat hud-streak">ğŸ”¥<span id="hud-streak">0</span></div>
      <div class="hud-stat hud-coins">â­<span id="hud-coins">0</span></div>
      <button class="hud-gear" onclick="toggleSettings()">âš™ï¸</button>
    </div>
  </div>

  <!-- Character + Voice Indicator -->
  <div class="char-zone">
    <div class="char-svg" id="char-el"></div>
    <div class="voice-indicator" id="voice-ind">
      <div class="voice-wave"><span></span><span></span><span></span><span></span><span></span></div>
      <span id="voice-text">Thinking...</span>
    </div>
  </div>

  <!-- Answer Cards (quiz mode) -->
  <div class="cards" id="cards" style="display:none"></div>

  <!-- Loading spinner -->
  <div class="cards-loading" id="loading" style="display:none">
    <div class="loader"><div class="loader-ring"></div><div class="loader-ring"></div><div class="loader-ring"></div></div>
  </div>

  <!-- Free talk input -->
  <div class="talk-bar" id="talk-bar">
    <button class="circle-btn mic-btn" id="mic" onclick="toggleMic()">ğŸ¤</button>
    <textarea class="talk-field" id="inp" rows="1" placeholder="Talk to me..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"></textarea>
    <button class="circle-btn send-btn" onclick="send()">â¤</button>
  </div>

  <!-- Subject selector bubbles -->
  <div class="subj-bar" id="subj-bar">
    <div class="subj-btn on" data-s="math" data-label="Math" onclick="switchSubject(this)">ğŸ”¢</div>
    <div class="subj-btn" data-s="reading" data-label="Read" onclick="switchSubject(this)">ğŸ“–</div>
    <div class="subj-btn" data-s="science" data-label="Science" onclick="switchSubject(this)">ğŸ”¬</div>
    <div class="subj-btn" data-s="free" data-label="Talk" onclick="switchSubject(this)">ğŸ¤</div>
  </div>
</div>

<!-- Streak fire effect -->
<div class="streak-fire" id="streak-fire"></div>

<!-- Reward burst overlay -->
<div class="reward-burst" id="reward" onclick="dismissReward()">
  <div class="rb-icon" id="rb-icon">â¬†ï¸</div>
  <div class="rb-title" id="rb-title">LEVEL UP!</div>
  <div class="rb-sub" id="rb-sub">Level 2</div>
  <div class="rb-dismiss">tap anywhere</div>
</div>

<!-- Settings -->
<div class="settings" id="settings">
  <div class="settings-top">
    <div class="settings-title">Settings</div>
    <button class="settings-x" onclick="toggleSettings()">âœ•</button>
  </div>
  <div class="settings-section">Voice</div>
  <div class="settings-row"><label>AI Voice</label><button class="tog on" id="tog-tts" onclick="togTTS(this)"></button></div>
  <div class="settings-section">Stats</div>
  <div class="settings-row"><label>Total XP</label><span class="stat-val" id="stat-xp">0</span></div>
  <div class="settings-row"><label>Questions</label><span class="stat-val" id="stat-q">0</span></div>
  <div class="settings-row"><label>Best Streak</label><span class="stat-val" id="stat-bs">0</span></div>
  <div class="settings-section">Data</div>
  <button class="reset-btn" onclick="if(confirm('Reset ALL progress?')){localStorage.removeItem('qt4');location.reload()}">Reset Everything</button>
</div>

<script>
// ===== STATE =====
const SAVE='qt4';
let cfg={provider:'anthropic',key:'',name:'',tts:true};
let gs={lv:1,xp:0,coins:0,streak:0,bestStreak:0,totalXP:0,totalQ:0,correct:0,subject:'math',chestProg:0};

function save(){localStorage.setItem(SAVE,JSON.stringify({cfg,gs}))}
function load(){try{const d=JSON.parse(localStorage.getItem(SAVE));if(d){Object.assign(cfg,d.cfg);Object.assign(gs,d.gs)}}catch(e){}}
load();

// ===== SETUP =====
if(cfg.key){document.getElementById('setup').classList.add('gone');document.getElementById('game').classList.add('on');setTimeout(init,200)}
document.getElementById('f-key').value=cfg.key;
document.getElementById('f-name').value=cfg.name;
if(cfg.provider!=='anthropic'){document.querySelectorAll('.s-pill').forEach(p=>{p.classList.toggle('on',p.dataset.p===cfg.provider)})}

function sPill(el){el.parentElement.querySelectorAll('.s-pill').forEach(p=>p.classList.remove('on'));el.classList.add('on');cfg.provider=el.dataset.p}

function startApp(){
  cfg.key=document.getElementById('f-key').value.trim();
  cfg.name=document.getElementById('f-name').value.trim()||'Adventurer';
  if(!cfg.key){alert('Please enter an API key!');return}
  save();
  document.getElementById('setup').classList.add('gone');
  document.getElementById('game').classList.add('on');
  setTimeout(init,200);
}

// ===== ANIMATED BACKGROUND (Canvas) =====
const canvas=document.getElementById('scene');
const ctx=canvas.getContext('2d');
let W,H;
const bgThemes={
  math:{colors:['#1a0533','#0d1b3e'],items:['â­','âœ¨','ğŸŒŸ','ğŸ’«','ğŸ”¢','â•','â–'],itemCount:18},
  reading:{colors:['#0a2a1f','#1a3a2a'],items:['ğŸ“–','âœ¨','ğŸŒ¿','ğŸ¦‹','ğŸ„','ğŸŒ¸','ğŸ›'],itemCount:18},
  science:{colors:['#0d1b3e','#1a0533'],items:['ğŸ”¬','âš—ï¸','ğŸ§ª','ğŸŒ','ğŸš€','â­','ğŸª'],itemCount:18},
  free:{colors:['#2a0a33','#1a0533'],items:['ğŸ¤','ğŸµ','ğŸ¶','âœ¨','ğŸ’¬','ğŸŒˆ','â­'],itemCount:15}
};

let bgItems=[];
function resizeCanvas(){
  W=canvas.width=window.innerWidth;
  H=canvas.height=window.innerHeight;
  initBgItems();
}
function initBgItems(){
  const theme=bgThemes[gs.subject]||bgThemes.math;
  bgItems=[];
  for(let i=0;i<theme.itemCount;i++){
    bgItems.push({
      x:Math.random()*W,y:Math.random()*H,
      vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.2-0.1,
      size:20+Math.random()*24,
      emoji:theme.items[Math.floor(Math.random()*theme.items.length)],
      opacity:0.08+Math.random()*0.12,
      rot:Math.random()*360,rotSpeed:(Math.random()-0.5)*0.5
    });
  }
}

function drawBg(){
  const theme=bgThemes[gs.subject]||bgThemes.math;
  const grad=ctx.createLinearGradient(0,0,W,H);
  grad.addColorStop(0,theme.colors[0]);grad.addColorStop(1,theme.colors[1]);
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Draw floating items
  for(const item of bgItems){
    item.x+=item.vx;item.y+=item.vy;item.rot+=item.rotSpeed;
    if(item.x<-40)item.x=W+40;if(item.x>W+40)item.x=-40;
    if(item.y<-40)item.y=H+40;if(item.y>H+40)item.y=-40;
    ctx.save();
    ctx.globalAlpha=item.opacity;
    ctx.translate(item.x,item.y);
    ctx.rotate(item.rot*Math.PI/180);
    ctx.font=item.size+'px serif';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(item.emoji,0,0);
    ctx.restore();
  }
  requestAnimationFrame(drawBg);
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();
drawBg();

// ===== SVG CHARACTER =====
function buildChar(){
  // Cute round character with big eyes â€” pure CSS/div based
  const el=document.getElementById('char-el');
  const faces={
    neutral:`<div style="width:140px;height:140px;border-radius:50%;background:linear-gradient(135deg,#7C4DFF,#448AFF);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 10px 40px rgba(124,77,255,0.5),inset 0 -5px 20px rgba(0,0,0,0.2)">
      <div style="position:absolute;top:32%;left:22%;width:28px;height:32px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center"><div style="width:16px;height:16px;background:#1a0533;border-radius:50%;position:relative;top:2px"><div style="width:6px;height:6px;background:white;border-radius:50%;position:absolute;top:2px;left:2px"></div></div></div>
      <div style="position:absolute;top:32%;right:22%;width:28px;height:32px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center"><div style="width:16px;height:16px;background:#1a0533;border-radius:50%;position:relative;top:2px"><div style="width:6px;height:6px;background:white;border-radius:50%;position:absolute;top:2px;left:2px"></div></div></div>
      <div style="position:absolute;top:62%;left:50%;transform:translateX(-50%);width:30px;height:14px;border-radius:0 0 15px 15px;background:#FF6B6B"></div>
      <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:32px">ğŸ‘‘</div>
    </div>`,
    happy:`<div style="width:140px;height:140px;border-radius:50%;background:linear-gradient(135deg,#FFD700,#FF6B6B);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 10px 40px rgba(255,215,0,0.5),inset 0 -5px 20px rgba(0,0,0,0.2)">
      <div style="position:absolute;top:35%;left:22%;width:28px;height:18px;border-radius:0 0 14px 14px;border-bottom:4px solid #1a0533;border-left:4px solid #1a0533;border-right:4px solid #1a0533"></div>
      <div style="position:absolute;top:35%;right:22%;width:28px;height:18px;border-radius:0 0 14px 14px;border-bottom:4px solid #1a0533;border-left:4px solid #1a0533;border-right:4px solid #1a0533"></div>
      <div style="position:absolute;top:58%;left:50%;transform:translateX(-50%);width:44px;height:24px;border-radius:0 0 22px 22px;background:#FF6B6B"></div>
      <div style="position:absolute;top:25%;left:10%;font-size:18px">âœ¨</div>
      <div style="position:absolute;top:20%;right:8%;font-size:18px">âœ¨</div>
      <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:32px">ğŸ‰</div>
    </div>`,
    sad:`<div style="width:140px;height:140px;border-radius:50%;background:linear-gradient(135deg,#6366F1,#818CF8);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 10px 40px rgba(99,102,241,0.4),inset 0 -5px 20px rgba(0,0,0,0.2)">
      <div style="position:absolute;top:32%;left:22%;width:28px;height:32px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center"><div style="width:16px;height:16px;background:#1a0533;border-radius:50%;position:relative;top:4px"><div style="width:6px;height:6px;background:white;border-radius:50%;position:absolute;top:1px;left:2px"></div></div></div>
      <div style="position:absolute;top:32%;right:22%;width:28px;height:32px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center"><div style="width:16px;height:16px;background:#1a0533;border-radius:50%;position:relative;top:4px"><div style="width:6px;height:6px;background:white;border-radius:50%;position:absolute;top:1px;left:2px"></div></div></div>
      <div style="position:absolute;top:66%;left:50%;transform:translateX(-50%);width:26px;height:12px;border-radius:12px 12px 0 0;border-top:3px solid #1a0533;border-left:3px solid #1a0533;border-right:3px solid #1a0533"></div>
      <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:32px">ğŸ’­</div>
    </div>`
  };
  el._faces=faces;
  el.innerHTML=faces.neutral;
}

function setMood(mood){
  const el=document.getElementById('char-el');
  if(!el._faces)return;
  el.innerHTML=el._faces[mood]||el._faces.neutral;
  el.classList.remove('happy','sad');
  if(mood==='happy'||mood==='sad'){
    void el.offsetWidth;
    el.classList.add(mood);
    setTimeout(()=>{el.classList.remove(mood);el.innerHTML=el._faces.neutral},1800);
  }
}

// ===== AUDIO =====
const actx=new(window.AudioContext||window.webkitAudioContext)();
function sfx(type){
  try{actx.resume();const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);
  const t=actx.currentTime;g.gain.setValueAtTime(0.12,t);
  if(type==='correct'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.08);o.frequency.setValueAtTime(784,t+.16);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  else if(type==='wrong'){o.frequency.setValueAtTime(200,t);o.type='sawtooth';g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3)}
  else if(type==='levelup'){o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.1);o.frequency.setValueAtTime(784,t+.2);o.frequency.setValueAtTime(1047,t+.3);g.gain.exponentialRampToValueAtTime(.001,t+.6);o.start(t);o.stop(t+.6)}
  else if(type==='coin'){o.frequency.setValueAtTime(1200,t);o.frequency.setValueAtTime(1600,t+.06);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)}
  else if(type==='chest'){o.frequency.setValueAtTime(440,t);o.frequency.setValueAtTime(554,t+.12);o.frequency.setValueAtTime(659,t+.24);o.frequency.setValueAtTime(880,t+.36);g.gain.exponentialRampToValueAtTime(.001,t+.7);o.start(t);o.stop(t+.7)}
  }catch(e){}
}

// ===== TTS =====
let bestVoice=null;
function findBestVoice(){
  const v=speechSynthesis.getVoices();if(!v.length)return null;
  const prefs=['Samantha (Enhanced)','Samantha','Zoe (Enhanced)','Zoe','Fiona (Enhanced)','Fiona',
    'Moira (Enhanced)','Tessa (Enhanced)','Karen (Enhanced)',
    'Google US English','Google UK English Female','Microsoft Zira','Microsoft Jenny'];
  for(const name of prefs){const f=v.find(x=>x.name===name);if(f)return f}
  const enhanced=v.find(x=>x.lang.startsWith('en')&&(x.name.includes('Enhanced')||x.name.includes('Premium')));
  if(enhanced)return enhanced;
  return v.find(x=>x.lang.startsWith('en')&&x.localService)||v.find(x=>x.lang.startsWith('en'))||v[0];
}
function loadVoices(){bestVoice=findBestVoice();if(!bestVoice)setTimeout(loadVoices,200)}
speechSynthesis.onvoiceschanged=()=>{bestVoice=findBestVoice()};
loadVoices();

let speakingNow=false;
async function speak(text){
  if(!cfg.tts)return;
  const clean=text.replace(/[\u{1F000}-\u{1FFFF}\u{2600}-\u{27BF}\u{FE00}-\u{FEFF}]/gu,'')
    .replace(/\[.*?\]/g,'').replace(/[*_#`]/g,'').replace(/\s+/g,' ').trim();
  if(!clean||clean.length<2)return;
  speechSynthesis.cancel();
  speakingNow=true;
  document.getElementById('voice-ind').classList.add('speaking');
  document.getElementById('voice-text').textContent='Listening...';

  const sentences=clean.match(/[^.!?]+[.!?]+|[^.!?]+$/g)||[clean];
  for(let i=0;i<sentences.length;i++){
    const s=sentences[i].trim();if(!s)continue;
    const u=new SpeechSynthesisUtterance(s);
    u.rate=0.85;u.pitch=1.15;u.volume=1;
    if(bestVoice)u.voice=bestVoice;
    if(i>0)await new Promise(r=>setTimeout(r,120));
    speechSynthesis.speak(u);
    if(i<sentences.length-1){
      await new Promise(r=>{u.onend=r;u.onerror=r;setTimeout(r,6000)});
    }else{
      u.onend=()=>{speakingNow=false;document.getElementById('voice-ind').classList.remove('speaking');document.getElementById('voice-text').textContent='Tap an answer!'};
      u.onerror=u.onend;
    }
  }
}

// ===== STT =====
let rec,listening=false;
function initRec(){
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window))return;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  rec=new SR();rec.continuous=false;rec.interimResults=false;rec.lang='en-US';
  rec.onresult=e=>{document.getElementById('inp').value=e.results[0][0].transcript;stopRec();send()};
  rec.onend=()=>stopRec();rec.onerror=()=>stopRec();
}
function toggleMic(){
  if(!rec)initRec();if(!rec)return;
  if(listening){rec.stop();stopRec()}
  else{try{rec.start();listening=true;document.getElementById('mic').classList.add('listening');document.getElementById('mic').textContent='ğŸ”´'}catch(e){}}
}
function stopRec(){listening=false;const b=document.getElementById('mic');b.classList.remove('listening');b.textContent='ğŸ¤'}

// ===== HUD =====
function updateHUD(){
  document.getElementById('hud-lv').textContent=gs.lv;
  const need=gs.lv*50;
  const pct=Math.min(1,gs.xp/need);
  const circ=125.66;
  document.getElementById('xp-ring').style.strokeDashoffset=circ-(circ*pct);
  document.getElementById('hud-streak').textContent=gs.streak;
  document.getElementById('hud-coins').textContent=gs.coins;
  document.getElementById('stat-xp').textContent=gs.totalXP;
  document.getElementById('stat-q').textContent=gs.totalQ;
  document.getElementById('stat-bs').textContent=gs.bestStreak;
  // Streak fire
  document.getElementById('streak-fire').classList.toggle('on',gs.streak>=3);
  save();
}

function addXP(n){
  gs.xp+=n;gs.totalXP+=n;
  const need=gs.lv*50;
  if(gs.xp>=need){gs.xp-=need;gs.lv++;sfx('levelup');showReward('â¬†ï¸','LEVEL '+gs.lv+'!','Keep going!');confetti()}
  floatXP(n);updateHUD();
}
function addCoins(n){gs.coins+=n;sfx('coin');updateHUD()}

function floatXP(n){
  const el=document.createElement('div');el.className='xp-fly';el.textContent='+'+n+' XP';
  el.style.left=Math.random()*50+25+'%';el.style.top='35%';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1500);
}

// ===== CONFETTI =====
function confetti(){
  const colors=['#FFD700','#22c55e','#3B82F6','#8B5CF6','#EC4899','#EF4444','#F59E0B'];
  for(let i=0;i<40;i++){
    const c=document.createElement('div');c.className='confetti';
    c.style.cssText=`left:${Math.random()*100}%;top:-10px;background:${colors[i%colors.length]};width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;--dx:${(Math.random()-0.5)*250}px;--dy:${300+Math.random()*500}px;--rot:${Math.random()*720}deg;--dur:${1+Math.random()*1.5}s;border-radius:${Math.random()>0.5?'50%':'2px'}`;
    document.body.appendChild(c);setTimeout(()=>c.remove(),3000);
  }
}

// ===== STAR BURST (on correct) =====
function starBurst(x,y){
  const emojis=['â­','ğŸŒŸ','âœ¨','ğŸ’«','ğŸ‰'];
  for(let i=0;i<8;i++){
    const s=document.createElement('div');s.className='star-burst';
    const angle=(i/8)*Math.PI*2;
    s.style.cssText=`left:${x}px;top:${y}px;font-size:${20+Math.random()*16}px;--tx:0px;--ty:0px;--dx:${Math.cos(angle)*120}px;--dy:${Math.sin(angle)*120}px`;
    s.textContent=emojis[Math.floor(Math.random()*emojis.length)];
    document.body.appendChild(s);setTimeout(()=>s.remove(),900);
  }
}

// ===== SCREEN EFFECTS =====
function flashScreen(color){
  const el=document.getElementById('flash');
  el.classList.add(color);setTimeout(()=>el.classList.remove(color),300);
}

// ===== REWARD OVERLAY =====
function showReward(icon,title,sub){
  document.getElementById('rb-icon').textContent=icon;
  document.getElementById('rb-title').textContent=title;
  document.getElementById('rb-sub').textContent=sub;
  document.getElementById('reward').classList.add('show');
}
function dismissReward(){document.getElementById('reward').classList.remove('show')}

// ===== EMOJI MAP for visual answers =====
// Maps common answer concepts to emojis so answers are VISUAL
const emojiMap={
  // Numbers
  '0':'0ï¸âƒ£','1':'1ï¸âƒ£','2':'2ï¸âƒ£','3':'3ï¸âƒ£','4':'4ï¸âƒ£','5':'5ï¸âƒ£','6':'6ï¸âƒ£','7':'7ï¸âƒ£','8':'8ï¸âƒ£','9':'9ï¸âƒ£',
  '10':'ğŸ”Ÿ','11':'1ï¸âƒ£1ï¸âƒ£','12':'1ï¸âƒ£2ï¸âƒ£','13':'1ï¸âƒ£3ï¸âƒ£','14':'1ï¸âƒ£4ï¸âƒ£','15':'1ï¸âƒ£5ï¸âƒ£','16':'1ï¸âƒ£6ï¸âƒ£','17':'1ï¸âƒ£7ï¸âƒ£','18':'1ï¸âƒ£8ï¸âƒ£','19':'1ï¸âƒ£9ï¸âƒ£','20':'2ï¸âƒ£0ï¸âƒ£',
  // Animals
  'dog':'ğŸ•','cat':'ğŸ±','fish':'ğŸŸ','bird':'ğŸ¦','lion':'ğŸ¦','tiger':'ğŸ¯','bear':'ğŸ»','elephant':'ğŸ˜',
  'monkey':'ğŸµ','rabbit':'ğŸ°','frog':'ğŸ¸','turtle':'ğŸ¢','snake':'ğŸ','dolphin':'ğŸ¬','whale':'ğŸ³',
  'penguin':'ğŸ§','owl':'ğŸ¦‰','eagle':'ğŸ¦…','shark':'ğŸ¦ˆ','octopus':'ğŸ™','butterfly':'ğŸ¦‹','bee':'ğŸ',
  'ant':'ğŸœ','spider':'ğŸ•·ï¸','dinosaur':'ğŸ¦•','dragon':'ğŸ‰','fox':'ğŸ¦Š','wolf':'ğŸº','horse':'ğŸ´',
  'cow':'ğŸ„','pig':'ğŸ·','chicken':'ğŸ”','duck':'ğŸ¦†','mouse':'ğŸ­',
  // Nature
  'sun':'â˜€ï¸','moon':'ğŸŒ™','star':'â­','cloud':'â˜ï¸','rain':'ğŸŒ§ï¸','snow':'â„ï¸','rainbow':'ğŸŒˆ',
  'tree':'ğŸŒ³','flower':'ğŸŒº','mountain':'â›°ï¸','ocean':'ğŸŒŠ','river':'ğŸï¸','forest':'ğŸŒ²','desert':'ğŸœï¸',
  'volcano':'ğŸŒ‹','earth':'ğŸŒ','planet':'ğŸª','rocket':'ğŸš€','fire':'ğŸ”¥','water':'ğŸ’§','leaf':'ğŸƒ',
  // Shapes
  'circle':'ğŸ”µ','square':'ğŸŸ©','triangle':'ğŸ”º','heart':'â¤ï¸','star shape':'â­','diamond':'ğŸ’',
  // Colors
  'red':'ğŸ”´','blue':'ğŸ”µ','green':'ğŸŸ¢','yellow':'ğŸŸ¡','orange':'ğŸŸ ','purple':'ğŸŸ£','pink':'ğŸ’—','black':'âš«','white':'âšª','brown':'ğŸŸ¤',
  // Food
  'apple':'ğŸ','banana':'ğŸŒ','pizza':'ğŸ•','cake':'ğŸ‚','cookie':'ğŸª','ice cream':'ğŸ¦','candy':'ğŸ¬',
  'watermelon':'ğŸ‰','grape':'ğŸ‡','strawberry':'ğŸ“','corn':'ğŸŒ½','carrot':'ğŸ¥•','broccoli':'ğŸ¥¦',
  // Objects
  'book':'ğŸ“š','pencil':'âœï¸','house':'ğŸ ','car':'ğŸš—','train':'ğŸš‚','airplane':'âœˆï¸','boat':'â›µ',
  'ball':'âš½','bicycle':'ğŸš²','clock':'ğŸ•','phone':'ğŸ“±','computer':'ğŸ’»','robot':'ğŸ¤–','key':'ğŸ”‘',
  // Minecraft
  'creeper':'ğŸ’š','diamond':'ğŸ’','sword':'âš”ï¸','pickaxe':'â›ï¸','block':'ğŸ§±','tnt':'ğŸ§¨',
  // Activities
  'swim':'ğŸŠ','run':'ğŸƒ','dance':'ğŸ’ƒ','sing':'ğŸ¤','paint':'ğŸ¨','read':'ğŸ“–','sleep':'ğŸ˜´','eat':'ğŸ½ï¸',
  // Math operations
  'plus':'â•','minus':'â–','times':'âœ–ï¸','divide':'â—','equals':'ğŸŸ°',
  // Yes/No
  'yes':'âœ…','no':'âŒ','true':'âœ…','false':'âŒ',
  // Seasons
  'spring':'ğŸŒ¸','summer':'â˜€ï¸','fall':'ğŸ‚','autumn':'ğŸ‚','winter':'â„ï¸',
};

function findEmoji(text){
  const lower=text.toLowerCase().trim();
  // Direct number match
  if(/^\d+$/.test(lower)&&parseInt(lower)<=20)return emojiMap[lower]||'ğŸ”¢';
  if(/^\d+$/.test(lower))return 'ğŸ”¢';
  // Search in map
  for(const[key,emoji] of Object.entries(emojiMap)){
    if(lower===key||lower.includes(key))return emoji;
  }
  // Check if text starts with emoji already
  const emojiRegex=/^[\u{1F000}-\u{1FFFF}\u{2600}-\u{27BF}]/u;
  if(emojiRegex.test(text.trim()))return text.trim().match(/^.{1,2}/u)[0];
  // Fallback based on subject
  if(gs.subject==='math')return 'ğŸ”¢';
  if(gs.subject==='reading')return 'ğŸ“';
  if(gs.subject==='science')return 'ğŸ”¬';
  return 'ğŸ’¡';
}

// ===== AI =====
let history=[];
let busy=false;

function sysPrompt(){
  const subjectGuides={
    math:`FOCUS: 1st Grade Math. Skills: addition/subtraction within 20, counting, shapes, patterns, comparing numbers.
METHOD: Make questions about Minecraft, animals, Mr Beast. Use small numbers.`,
    reading:`FOCUS: 1st Grade Reading/Phonics. Skills: CVC words, sight words, rhyming, letter sounds, simple spelling.
METHOD: Use fun words, animal names, Minecraft items.`,
    science:`FOCUS: 1st Grade Science. Topics: animals, habitats, weather, space, dinosaurs, ocean, plants.
METHOD: Frame as adventures and discoveries.`,
    free:`Free conversation mode. Be a fun enthusiastic friend who loves Minecraft, animals, and Mr Beast. Keep it exciting!`
  };

  return `You are Quest Buddy, a super fun, wildly enthusiastic learning companion for ${cfg.name}, a 6-year-old who LOVES Minecraft, Mr Beast, gaming, animals, and building things.

${subjectGuides[gs.subject]||subjectGuides.math}

${gs.subject==='free'?`RESPONSE FORMAT:
- Keep responses very SHORT (1-2 sentences)
- Be excited and fun
- Ask a question to keep conversation going`
:`CRITICAL RESPONSE FORMAT (follow EXACTLY):
- Ask ONE short question (max 12 words)
- Give EXACTLY 3 answer choices: A), B), C) â€” each choice is 1-3 words MAX
- End with ANSWER: X (where X is A, B, or C)
- Make answers CONCRETE nouns or small numbers when possible (animals, objects, colors, numbers under 20)
- Example format:
How many legs does a spider have? ğŸ•·ï¸
A) 6
B) 8
C) 10
ANSWER: B

RULES:
- Choices must be SHORT (1-3 words each) â€” a 6-year-old can barely read!
- Use concrete things (animals, objects, numbers) NOT abstract words
- Make it fun with emojis in the question
- 70% easy wins, 30% stretch challenges`}

PERSONALITY: Be WILDLY enthusiastic. Every question is the coolest thing ever. Use Minecraft/gaming references. Current streak: ${gs.streak}${gs.streak>=3?' â€” mention the streak!':''}`;
}

async function callAPI(msgs){
  if(!msgs||msgs.length===0)msgs=[{r:'user',t:'Give me a fun question!'}];
  try{
    if(cfg.provider==='anthropic'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',headers:{'Content-Type':'application/json','x-api-key':cfg.key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-sonnet-4-5-20250929',max_tokens:200,system:sysPrompt(),messages:msgs.map(m=>({role:m.r==='bot'?'assistant':'user',content:m.t}))})
      });
      if(!r.ok)throw new Error(await r.text());
      return(await r.json()).content[0].text;
    }else if(cfg.provider==='openai'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
        body:JSON.stringify({model:'gpt-4o-mini',max_tokens:200,messages:[{role:'system',content:sysPrompt()},...msgs.map(m=>({role:m.r==='bot'?'assistant':'user',content:m.t}))]})
      });
      if(!r.ok)throw new Error(''+r.status);
      return(await r.json()).choices[0].message.content;
    }else{
      const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
        method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
        body:JSON.stringify({model:'llama-3.3-70b-versatile',max_tokens:200,messages:[{role:'system',content:sysPrompt()},...msgs.map(m=>({role:m.r==='bot'?'assistant':'user',content:m.t}))]})
      });
      if(!r.ok)throw new Error(''+r.status);
      return(await r.json()).choices[0].message.content;
    }
  }catch(e){console.error(e);return`Oops! Try again? (${e.message?.substring(0,60)})`}
}

function parseResponse(text){
  const lines=text.split('\n').filter(l=>l.trim());
  let question='';let choices=[];let correctLetter='';
  for(const line of lines){
    const ans=line.match(/^ANSWER:\s*([A-D])/i);
    if(ans){correctLetter=ans[1].toUpperCase();continue}
    const ch=line.match(/^([A-D])\)\s*(.+)/i);
    if(ch){choices.push({letter:ch[1].toUpperCase(),text:ch[2].trim()});continue}
    if(choices.length===0)question+=(question?' ':'')+line;
  }
  return{question:question.trim(),choices,correctLetter};
}

function showLoading(){
  document.getElementById('cards').style.display='none';
  document.getElementById('loading').style.display='flex';
  document.getElementById('voice-ind').classList.add('speaking');
  document.getElementById('voice-text').textContent='Thinking...';
}
function hideLoading(){
  document.getElementById('loading').style.display='none';
}

function renderCards(choices,correctLetter){
  const div=document.getElementById('cards');
  div.innerHTML='';div.style.display='grid';
  hideLoading();

  // If 3 choices, use different layout
  if(choices.length===3){
    div.style.gridTemplateColumns='1fr 1fr';
    div.style.gridTemplateRows='1fr 1fr';
  }else{
    div.style.gridTemplateColumns='1fr 1fr';
  }

  choices.forEach((ch,i)=>{
    const card=document.createElement('div');card.className='card';
    const emoji=findEmoji(ch.text);
    card.innerHTML=`<div class="card-icon">${emoji}</div><div class="card-label">${ch.text}</div>`;
    card.onclick=(e)=>handleAnswer(ch.letter,correctLetter,card,e);

    // If 3 choices and this is the 3rd, span full width
    if(choices.length===3&&i===2){card.style.gridColumn='1 / -1'}
    div.appendChild(card);
  });
}

function handleAnswer(picked,correct,card,event){
  if(busy)return;
  busy=true;gs.totalQ++;
  const isCorrect=picked===correct;

  // Disable all cards
  document.querySelectorAll('.card').forEach(c=>c.style.pointerEvents='none');

  if(isCorrect){
    card.classList.add('correct');
    gs.streak++;gs.correct++;
    if(gs.streak>gs.bestStreak)gs.bestStreak=gs.streak;
    sfx('correct');setMood('happy');flashScreen('green');

    // Star burst at tap position
    const rect=card.getBoundingClientRect();
    starBurst(rect.left+rect.width/2,rect.top+rect.height/2);

    const xp=10+(gs.streak>=5?5:0);
    addXP(xp);
    if(gs.streak%3===0)addCoins(5);

    gs.chestProg++;
    if(gs.chestProg>=7){gs.chestProg=0;sfx('chest');confetti();showReward('ğŸ','TREASURE!','+ 10 Stars â­');addCoins(10)}

    // Dim wrong answers
    document.querySelectorAll('.card').forEach(c=>{if(c!==card)c.classList.add('dimmed')});

    speak("Amazing! That's right!");

    setTimeout(()=>{
      history.push({r:'user',t:`Correct! ${picked} was right! Give me another question!`});
      getAI();
    },1500);
  }else{
    card.classList.add('wrong');
    gs.streak=0;
    sfx('wrong');setMood('sad');flashScreen('red');
    document.getElementById('game').classList.add('screen-shake');
    setTimeout(()=>document.getElementById('game').classList.remove('screen-shake'),400);

    // Show correct
    document.querySelectorAll('.card').forEach(c=>{
      const lbl=c.querySelector('.card-label').textContent;
      const idx=Array.from(c.parentElement.children).indexOf(c);
      const letter=['A','B','C','D'][idx];
      if(letter===correct)c.classList.add('correct');
      else if(c!==card)c.classList.add('dimmed');
    });

    speak("Oops! Good try though!");

    setTimeout(()=>{
      history.push({r:'user',t:`I picked ${picked} but it was ${correct}. Give me a new question!`});
      getAI();
    },2200);
  }
  updateHUD();save();
}

async function getAI(){
  busy=true;showLoading();
  const resp=await callAPI(history);
  history.push({r:'bot',t:resp});
  if(history.length>16)history=history.slice(-12);

  const isFree=gs.subject==='free';

  if(isFree){
    hideLoading();
    document.getElementById('cards').style.display='none';
    document.getElementById('talk-bar').classList.add('on');
    document.getElementById('subj-bar').style.display='flex';
    document.getElementById('voice-text').textContent='Talking...';
    speak(resp);
    busy=false;
  }else{
    const parsed=parseResponse(resp);
    if(parsed.choices.length>=2){
      renderCards(parsed.choices,parsed.correctLetter);
      document.getElementById('talk-bar').classList.remove('on');
      document.getElementById('subj-bar').style.display='flex';
      // Speak just the question
      speak(parsed.question||resp.split('\n')[0]);
      document.getElementById('voice-text').textContent='Pick one!';
    }else{
      // Parse failed â€” retry
      hideLoading();
      document.getElementById('voice-text').textContent='Hmm, one sec...';
      history.push({r:'user',t:'Please give me a question with exactly 3 choices: A), B), C) and ANSWER: at the end.'});
      getAI();
      return;
    }
    busy=false;
  }
}

function send(){
  const inp=document.getElementById('inp');
  const t=inp.value.trim();if(!t||busy)return;
  inp.value='';
  history.push({r:'user',t});
  getAI();
}

// ===== SUBJECTS =====
function switchSubject(el){
  document.querySelectorAll('.subj-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');gs.subject=el.dataset.s;save();
  history=[];
  initBgItems(); // change background theme
  const isFree=gs.subject==='free';
  document.getElementById('talk-bar').classList.toggle('on',isFree);
  document.getElementById('cards').style.display=isFree?'none':'grid';
  document.getElementById('voice-text').textContent='Loading...';
  history.push({r:'user',t:`Let's do ${gs.subject}! Give me a fun question!`});
  getAI();
}

// ===== SETTINGS =====
function toggleSettings(){document.getElementById('settings').classList.toggle('show')}
function togTTS(el){cfg.tts=!cfg.tts;el.classList.toggle('on',cfg.tts);save()}

// ===== INIT =====
function init(){
  buildChar();updateHUD();initRec();

  // Set correct subject tab
  document.querySelectorAll('.subj-btn').forEach(b=>b.classList.toggle('on',b.dataset.s===gs.subject));

  const isFree=gs.subject==='free';
  document.getElementById('talk-bar').classList.toggle('on',isFree);

  document.getElementById('voice-text').textContent='Loading...';
  history.push({r:'user',t:`Hi! I'm ${cfg.name}. Give me a fun ${gs.subject} question!`});
  getAI();
}

// PWA
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});
</script>
</body>
</html>
